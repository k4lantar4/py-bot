#!/bin/bash

# ุชูุธู ุฑูฺฏโูุง ุจุฑุง ุฎุฑูุฌ
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${YELLOW}===================================================${NC}"
echo -e "${YELLOW}๐ง MRJBot - ุงุตูุงุญ ูุดฺฉูุงุช ุฎุงุต Ubuntu${NC}"
echo -e "${YELLOW}===================================================${NC}"

# ุงุตูุงุญ ุฏุณุชุฑุณโูุง ูุงูโูุง
echo -e "${YELLOW}๐ ุชูุธู ุฏุณุชุฑุณโูุง ูุงูโูุง...${NC}"

# ุงุนุทุง ุฏุณุชุฑุณ ุงุฌุฑุง ุจู ููู ุงุณฺฉุฑูพุชโูุง ุดู
find . -name "*.sh" -exec chmod +x {} \;
echo -e "${GREEN}โ ุฏุณุชุฑุณ ุงุฌุฑุง ุจู ุชูุงู ุงุณฺฉุฑูพุชโูุง ุดู ุงุนุทุง ุดุฏ.${NC}"

# ุงุนุทุง ุฏุณุชุฑุณ ุงุฌุฑุง ุจู ูุงูโูุง ุฎุงุต
chmod +x bot/entrypoint.sh
chmod +x bot/wait_for_db.py
echo -e "${GREEN}โ ุฏุณุชุฑุณ ุงุฌุฑุง ุจู ูุงูโูุง ฺฉูุฏ ุงุนุทุง ุดุฏ.${NC}"

# ุชุจุฏู ูุฑูุช ุฎุทโูุง ุงุฒ DOS ุจู UNIX
echo -e "${YELLOW}๐ ุชุจุฏู ูุฑูุช ุฎุทโูุง ุงุฒ DOS ุจู UNIX...${NC}"
if command -v dos2unix &> /dev/null; then
    find . -name "*.sh" -exec dos2unix {} \;
    find . -name "*.py" -exec dos2unix {} \;
    echo -e "${GREEN}โ ูุฑูุช ุฎุทโูุง ุจุง ููููุช ุชุจุฏู ุดุฏ.${NC}"
else
    echo -e "${YELLOW}โ๏ธ dos2unix ูุตุจ ูุณุช. ุฏุฑ ุญุงู ูุตุจ...${NC}"
    apt-get update && apt-get install -y dos2unix
    find . -name "*.sh" -exec dos2unix {} \;
    find . -name "*.py" -exec dos2unix {} \;
    echo -e "${GREEN}โ dos2unix ูุตุจ ุดุฏ ู ูุฑูุช ุฎุทโูุง ุชุจุฏู ุดุฏ.${NC}"
fi

# ูพุงฺฉุณุงุฒ ู ุจุงุฒุณุงุฒ ุชุตุงูุฑ ุฏุงฺฉุฑ
echo -e "${YELLOW}๐ ูพุงฺฉุณุงุฒ ู ุจุงุฒุณุงุฒ ุชุตุงูุฑ ุฏุงฺฉุฑ...${NC}"
docker-compose down || true
docker system prune -af
docker-compose build --no-cache
echo -e "${GREEN}โ ุชุตุงูุฑ ุฏุงฺฉุฑ ุจุง ููููุช ุจุงุฒุณุงุฒ ุดุฏูุฏ.${NC}"

# ุฑุงูโุงูุฏุงุฒ ุณุฑูุณโูุง
echo -e "${YELLOW}๐ ุฑุงูโุงูุฏุงุฒ ุณุฑูุณโูุง...${NC}"
docker-compose up -d
echo -e "${GREEN}โ ุณุฑูุณโูุง ุจุง ููููุช ุฑุงูโุงูุฏุงุฒ ุดุฏูุฏ.${NC}"

# ุจุฑุฑุณ ูุถุนุช ุณุฑูุณโูุง
echo -e "${YELLOW}๐ ุจุฑุฑุณ ูุถุนุช ุณุฑูุณโูุง...${NC}"
docker-compose ps

echo -e "${GREEN}โ ุชูุงู ุงุตูุงุญุงุช ุจุง ููููุช ุงูุฌุงู ุดุฏ.${NC}"
echo -e "${YELLOW}๐ก ุจุฑุง ูุดุงูุฏู ูุงฺฏโูุงุ ุฏุณุชูุฑ ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:${NC}"
echo -e "   docker-compose logs -f"
echo -e "${YELLOW}๐ก ุจุฑุง ูุดุงูุฏู ูุงฺฏ ุณุฑูุณ ุจุงุชุ ุฏุณุชูุฑ ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:${NC}"
echo -e "   docker-compose logs -f bot" 