#!/bin/bash

# Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m' # Ø¨Ø¯ÙˆÙ† Ø±Ù†Ú¯

# Ù…Ø³ÛŒØ± Ù†ØµØ¨
INSTALL_DIR="/opt/mrjbot"
COMPOSE_FILE="$INSTALL_DIR/docker-compose.yml"
BACKUP_DIR="$INSTALL_DIR/backups"

# ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§
show_help() {
    echo -e "${BLUE}===================================================${NC}"
    echo -e "${BLUE}MRJBot - Ø§Ø¨Ø²Ø§Ø± Ø®Ø· ÙØ±Ù…Ø§Ù†${NC}"
    echo -e "${BLUE}===================================================${NC}"
    echo -e "Ø§Ø³ØªÙØ§Ø¯Ù‡: mrjbot [Ø¯Ø³ØªÙˆØ±]"
    echo
    echo -e "Ø¯Ø³ØªÙˆØ±Ø§Øª:"
    echo -e "  ${GREEN}start${NC}              Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ù… Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§"
    echo -e "  ${GREEN}stop${NC}               ØªÙˆÙ‚Ù ØªÙ…Ø§Ù… Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§"
    echo -e "  ${GREEN}restart${NC}            Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ ØªÙ…Ø§Ù… Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§"
    echo -e "  ${GREEN}status${NC}             Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§"
    echo -e "  ${GREEN}logs [service]${NC}     Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ: Ù†Ø§Ù… Ø³Ø±ÙˆÛŒØ³)"
    echo -e "  ${GREEN}shell [service]${NC}    ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù„ Ú©Ø§Ù†ØªÛŒÙ†Ø± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ: Ù†Ø§Ù… Ø³Ø±ÙˆÛŒØ³)"
    echo -e "  ${GREEN}update${NC}             Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ…"
    echo -e "  ${GREEN}backup${NC}             ØªÙ‡ÛŒÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø² Ø³ÛŒØ³ØªÙ…"
    echo -e "  ${GREEN}restore [file]${NC}     Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†)"
    echo -e "  ${GREEN}set-license [code]${NC} ØªÙ†Ø¸ÛŒÙ… Ú©Ø¯ Ù„Ø§ÛŒØ³Ù†Ø³"
    echo -e "  ${GREEN}test${NC}               Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…"
    echo -e "  ${GREEN}help${NC}               Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§"
    echo
}

# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§
check_prerequisites() {
    if [ ! -f "$COMPOSE_FILE" ]; then
        echo -e "${RED}Ø®Ø·Ø§: ÙØ§ÛŒÙ„ docker-compose.yml Ø¯Ø± Ù…Ø³ÛŒØ± $COMPOSE_FILE ÛŒØ§ÙØª Ù†Ø´Ø¯.${NC}"
        echo -e "${YELLOW}Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù†ÛŒØ¯ Ú©Ù‡ MRJBot Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ù†ØµØ¨ Ø´Ø¯Ù‡ Ø§Ø³Øª.${NC}"
        exit 1
    fi
    
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}Ø®Ø·Ø§: Docker Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.${NC}"
        echo -e "${YELLOW}Ù„Ø·ÙØ§Ù‹ Docker Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.${NC}"
        exit 1
    fi
    
    if ! command -v docker-compose &> /dev/null; then
        echo -e "${RED}Ø®Ø·Ø§: Docker Compose Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.${NC}"
        echo -e "${YELLOW}Ù„Ø·ÙØ§Ù‹ Docker Compose Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.${NC}"
        exit 1
    fi
}

# ØªØ§Ø¨Ø¹ Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
start_services() {
    echo -e "${BLUE}Ø¯Ø± Ø­Ø§Ù„ Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ MRJBot...${NC}"
    cd $INSTALL_DIR && docker-compose up -d
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø±ÙˆØ¹ Ø´Ø¯Ù†Ø¯.${NC}"
    else
        echo -e "${RED}Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§.${NC}"
        exit 1
    fi
}

# ØªØ§Ø¨Ø¹ ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
stop_services() {
    echo -e "${BLUE}Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ MRJBot...${NC}"
    cd $INSTALL_DIR && docker-compose down
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù†Ø¯.${NC}"
    else
        echo -e "${RED}Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§.${NC}"
        exit 1
    fi
}

# ØªØ§Ø¨Ø¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
restart_services() {
    echo -e "${BLUE}Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ MRJBot...${NC}"
    cd $INSTALL_DIR && docker-compose restart
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø´Ø¯Ù†Ø¯.${NC}"
    else
        echo -e "${RED}Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§.${NC}"
        exit 1
    fi
}

# ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
show_status() {
    echo -e "${BLUE}ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ MRJBot:${NC}"
    cd $INSTALL_DIR && docker-compose ps
}

# ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§
show_logs() {
    if [ -z "$1" ]; then
        echo -e "${BLUE}Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø§Ù… Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§:${NC}"
        cd $INSTALL_DIR && docker-compose logs --tail=100
    else
        echo -e "${BLUE}Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³ $1:${NC}"
        cd $INSTALL_DIR && docker-compose logs --tail=100 $1
    fi
}

# ØªØ§Ø¨Ø¹ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù„ Ú©Ø§Ù†ØªÛŒÙ†Ø±
enter_shell() {
    if [ -z "$1" ]; then
        echo -e "${YELLOW}Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.${NC}"
        echo -e "${BLUE}Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:${NC}"
        cd $INSTALL_DIR && docker-compose ps --services
        exit 1
    else
        echo -e "${BLUE}ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù„ Ø³Ø±ÙˆÛŒØ³ $1:${NC}"
        cd $INSTALL_DIR && docker-compose exec $1 /bin/bash || docker-compose exec $1 /bin/sh
    fi
}

# ØªØ§Ø¨Ø¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ…
update_system() {
    echo -e "${BLUE}Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ MRJBot...${NC}"
    
    # ØªÙ‡ÛŒÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
    backup_system "pre-update"
    
    # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø¯ Ø§Ø² Ù…Ø®Ø²Ù†
    cd $INSTALL_DIR
    git pull
    
    # Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§
    docker-compose down
    docker-compose build
    docker-compose up -d
    
    echo -e "${GREEN}Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.${NC}"
    
    # Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹Ù„Ø§Ù† Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ø§Ø¯Ù…ÛŒÙ† ØªÙ„Ú¯Ø±Ø§Ù…
    if [ -f "$INSTALL_DIR/.env" ]; then
        ADMIN_CHAT_ID=$(grep TELEGRAM_ADMIN_CHAT_ID $INSTALL_DIR/.env | cut -d '=' -f2)
        BOT_TOKEN=$(grep TELEGRAM_BOT_TOKEN $INSTALL_DIR/.env | cut -d '=' -f2)
        
        if [ ! -z "$ADMIN_CHAT_ID" ] && [ ! -z "$BOT_TOKEN" ]; then
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d chat_id="$ADMIN_CHAT_ID" \
                -d text="ğŸ”¥ Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§ÙˆÙ…Ø¯ØŒ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯! ğŸ”¥" > /dev/null
        fi
    fi
}

# ØªØ§Ø¨Ø¹ ØªÙ‡ÛŒÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
backup_system() {
    # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
    mkdir -p $BACKUP_DIR
    
    # ØªØ¹ÛŒÛŒÙ† Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
    BACKUP_NAME=${1:-"backup"}
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    BACKUP_FILE="$BACKUP_DIR/${BACKUP_NAME}_${TIMESTAMP}.tar.gz"
    
    echo -e "${BLUE}Ø¯Ø± Ø­Ø§Ù„ ØªÙ‡ÛŒÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø² MRJBot...${NC}"
    
    # ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    cd $INSTALL_DIR && docker-compose stop
    
    # ØªÙ‡ÛŒÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø² ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ùˆ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    tar -czf $BACKUP_FILE -C $INSTALL_DIR .env docker-compose.yml backend/config/settings.py \
        $(docker volume ls -q | grep mrjbot)
    
    # Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    cd $INSTALL_DIR && docker-compose start
    
    echo -e "${GREEN}Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± $BACKUP_FILE Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.${NC}"
}

# ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
restore_backup() {
    if [ -z "$1" ]; then
        echo -e "${YELLOW}Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.${NC}"
        echo -e "${BLUE}Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:${NC}"
        ls -la $BACKUP_DIR
        exit 1
    fi
    
    BACKUP_FILE="$BACKUP_DIR/$1"
    
    if [ ! -f "$BACKUP_FILE" ]; then
        echo -e "${RED}Ø®Ø·Ø§: ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† $BACKUP_FILE ÛŒØ§ÙØª Ù†Ø´Ø¯.${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø² $BACKUP_FILE...${NC}"
    
    # ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    cd $INSTALL_DIR && docker-compose down
    
    # Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
    tar -xzf $BACKUP_FILE -C $INSTALL_DIR
    
    # Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    cd $INSTALL_DIR && docker-compose up -d
    
    echo -e "${GREEN}Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯.${NC}"
}

# ØªØ§Ø¨Ø¹ ØªÙ†Ø¸ÛŒÙ… Ù„Ø§ÛŒØ³Ù†Ø³
set_license() {
    if [ -z "$1" ]; then
        echo -e "${YELLOW}Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù„Ø§ÛŒØ³Ù†Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.${NC}"
        exit 1
    fi
    
    LICENSE_CODE="$1"
    LICENSE_FILE="$INSTALL_DIR/license.key"
    
    echo "$LICENSE_CODE" > $LICENSE_FILE
    echo -e "${GREEN}Ú©Ø¯ Ù„Ø§ÛŒØ³Ù†Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯.${NC}"
    
    # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    restart_services
}

# ØªØ§Ø¨Ø¹ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§
run_tests() {
    echo -e "${BLUE}Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ MRJBot...${NC}"
    cd $INSTALL_DIR && ./run_tests.sh
}

# Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§
check_prerequisites

# Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±Ø§Øª
case "$1" in
    start)
        start_services
        ;;
    stop)
        stop_services
        ;;
    restart)
        restart_services
        ;;
    status)
        show_status
        ;;
    logs)
        show_logs "$2"
        ;;
    shell)
        enter_shell "$2"
        ;;
    update)
        update_system
        ;;
    backup)
        backup_system "$2"
        ;;
    restore)
        restore_backup "$2"
        ;;
    set-license)
        set_license "$2"
        ;;
    test)
        run_tests
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        show_help
        exit 1
        ;;
esac

exit 0 